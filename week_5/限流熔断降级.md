# 第五周

## 隔离

隔离是对系统的资源进行分隔，保证当系统中出现故障是能够将故障限定到某一个较小的范围中。  
隔离的方式包括：  

1. 服务隔离
2. 资源隔离
3. 重要性隔离

## 超时控制

超时控制是微服务可用性的第一道关，良好的超时策略，可以尽可能让服务不堆积请求，尽快清空高延迟的请求，释放 Goroutine。  

注意事项：

1. 底层库应该有兜底的默认超时
2. 使用配置中心的公共模板

超时传递：

1. 进程内超时可以使用context.WithTimeout
2. 进程间超时传递可以使用Grpc metadata 或者 http header

## 限流

限流是服务器端进行流量控制的一种方式。

### 单机的限流算法

1. 令牌桶， 固定大小的桶，以一个定时的速率向桶中填充令牌，桶满时丢弃令牌。
2. 漏桶，固定桶大小，以固定的速率流出，可以用于流量整形

### 过载保护

过载保护是一种特化的限流方式，计算系统临近过载时的峰值吞吐作为限流的阈值来进行流量控制，达到系统保护。  

### 分布式限流

对应用进行全局的流量控制而非单个节点。  

最大最小公平分配算法

- 资源按照需求递增的顺序进行分配。
- 不存在用户得到的资源超过自己的需求。
- 未得到满足的用户等价的分享资源。

根据服务重要性， 确保优先级高的服务可以获取到更高的请求配额

## 熔断

一种客户端节流的方式，当下级服务出现故障时可以快速失败，避免雪球效应导致系统崩溃。  
请求拒绝率： max(0, requests - K * accepts/(requests+1))  
客户端流控
作用：避免positive feedback积极重试访问不可达的服务
限制请求频次，重试添加backoff退让策略
Gutter
gutter集群只需要主集群的10%的资源 主集群发生熔断被抛弃的请求会转移到gutter集群 如果gutter集群也接受不住流量，会重现抛到主集群

## 降级

提供有损的服务，降低回复的质量从而进行快速回复，减少计算量或时间。  

- UI 模块化，非核心模块降级。
  - BFF 层聚合 API，模块降级。
- 页面上一次缓存副本。
- 默认值、热门推荐等。
- 流量拦截 + 定期数据缓存(过期副本策略)。

处理策略

- 页面降级、延迟服务、写/读降级、缓存降级
- 抛异常、返回约定协议、Mock 数据、Fallback 处理

## 重试

当服务返回错误时进行立即重试。

重试可能会导致流量放大。  

- 应当限制重试次数和比率
- 使用随机或者指数重试时间
- client 测记录重试次数直方图，传递到 server，进行分布判定，交由 server 判定拒绝
- 只应该在失败的这层进行重试，当重试仍然失败，全局约定错误码“过载，无须重试”，避免级联重试

## 负载均衡

- 均衡的流量分发。
- 可靠的识别异常节点。
- scale-out，增加同质节点扩容。
- 减少错误，提高可用性。
